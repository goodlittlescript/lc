#!/bin/bash
. test/integration/helper

# helpers

setup_template_file () {
template_name="example"
template_file="$ts_test_dir/$template_name.erb"
mkdir -p "$ts_test_dir"
printf "%s" "$1" > "$template_file"
}

setup_attributes_file () {
template_name="example"
attributes_file="$ts_test_dir/$template_name.yml"
mkdir -p "$ts_test_dir"
printf "%s" "$1" > "$attributes_file"
}

#
# lc tests
#

test_lc_renders_file_with_args () {
setup_template_file "1 + 2 = <%= args.map(&:to_i).inject(0, &:+) %>"
lc "$template_file" 1 2 | assert_output "1 + 2 = 3"
}

test_lc_assigns_argnames_according_to_attributes_file () {
setup_template_file "1 + 2 = <%= a.to_i + b.to_i %>"
setup_attributes_file "\
args: [a, b]
"

lc "$template_file" 1 2 | assert_output "1 + 2 = 3"
}

test_lc_assigns_defaults_according_to_attributes_file () {
setup_template_file "1 + 2 = <%= a.to_i + b.to_i %>"
setup_attributes_file "\
args:
  a: 0
  b: 2
"

lc "$template_file" 1 | assert_output "1 + 2 = 3"
}

test_lc_recognizes_attributes_in_lc_files () {
mkdir -p "$ts_test_dir/dir"
cat > "$ts_test_dir/example.lc" <<DOC
args:
  a: 0
  b: 2
---
1 + 2 = <%= a.to_i + b.to_i %>
DOC

lc "$ts_test_dir/example.lc" 1 | assert_output "\
1 + 2 = 3
"
}

test_lc_looks_up_template_file_along_LC_PATH () {
setup_template_file "<%= 1 + 2 %>"
export LC_PATH="$ts_test_dir"
lc "$template_name" | assert_output "3"
}

test_lc_can_find_template_files_under_dir () {
mkdir -p "$ts_test_dir/dir"
printf "%s" "<%= 1 + 2 %>" > "$ts_test_dir/dir/template.erb"

export LC_PATH="$ts_test_dir"
lc dir/template | assert_output "3"
}

test_lc_prints_error_if_template_cannot_be_found_on_LC_PATH () {
export LC_PATH="$ts_test_dir"
lc missing 2>&1 | assert_output "\
could not find template: \"missing\"
"
}

test_lc_prints_error_if_no_template_is_specified () {
lc 2>&1 | assert_output "\
no template specified
"
}

#
# -f
#

test_lc_f_renders_template_for_each_line_in_csv_inputs () {
setup_template_file "\
got <%= args.join(' ') %>
"

csv_file_one="$ts_test_dir/one.csv"
printf "%s,%s,%s\n" a b c i j k > "$csv_file_one"

csv_file_two="$ts_test_dir/two.csv"
printf "%s,%s,%s\n" x y z > "$csv_file_two"

printf "%s,%s,%s\n" p q r |
lc -f "$template_file" "$csv_file_one" - "$csv_file_two" | assert_output "\
got a b c
got i j k
got p q r
got x y z
"
}

#
# -F
#

test_lc_F_sets_field_sep_for_csv_inputs () {
setup_template_file "\
got <%= args.join(' ') %>
"
printf "%s|%s|%s\n" a b c x y z |
lc -F '|' "$template_file" | assert_output "\
got a b c
got x y z
"
}

#
# -H
#

test_lc_H_specifies_each_csv_file_has_headers () {
setup_template_file "\
got <%= args.join(' ') %>
"

csv_file_one="$ts_test_dir/one.csv"
printf "%s,%s,%s\n" A B C a b c i j k > "$csv_file_one"

csv_file_two="$ts_test_dir/two.csv"
printf "%s,%s,%s\n" A B C x y z > "$csv_file_two"

printf "%s,%s,%s\n" A B C p q r |
lc -H "$template_file" "$csv_file_one" - "$csv_file_two" | assert_output "\
got a b c
got i j k
got p q r
got x y z
"
}

test_lc_H_maps_csv_fields_to_named_args_on_a_per_file_basis () {
setup_template_file "\
got <%= self.A %> <%= self.B %> <%= self.C %>
"
setup_attributes_file "\
args:
  A: a
  B: b
  C: c
"

# extra fields
csv_file_one="$ts_test_dir/one.csv"
printf "%s,%s,%s,%s\n" A B C D a b c d i j k l > "$csv_file_one"

# out-of-order fields
csv_file_two="$ts_test_dir/two.csv"
printf "%s,%s,%s\n" B C A y z x > "$csv_file_two"

# missing fields
printf "%s,%s\n" A B p q |
lc -H "$template_file" "$csv_file_one" - "$csv_file_two" | assert_output "\
got a b c
got i j k
got p q c
got x y z
"
}

#
# -I
#

test_lc_I_sets_LC_PATH () {
setup_template_file "<%= 1 + 2 %>"
lc -I "$ts_test_dir" "$template_name" | assert_output "3"
}

#
# -l
#

test_lc_l_prints_list_of_templates_on_LC_PATH () {
mkdir -p "$ts_test_dir"
touch "$ts_test_dir/abc.erb"
touch "$ts_test_dir/xyz.erb"
export LC_PATH="$ts_test_dir"
lc -l | assert_output "\
abc
xyz
"
}

test_lc_l_prints_desc_as_in_attributes_file_if_present () {
mkdir -p "$ts_test_dir"

touch "$ts_test_dir/abc.erb"
cat > "$ts_test_dir/abc.yml" <<DOC
desc: "the abc template"
DOC

touch "$ts_test_dir/xyz.erb"
cat > "$ts_test_dir/xyz.yml" <<DOC
# no desc
DOC

export LC_PATH="$ts_test_dir"
lc -l | assert_output "\
abc    the abc template
xyz
"
}

#
# -h
#

test_lc_h_prints_help () {
lc -h | grep -q "usage: lc"
}

. ts
