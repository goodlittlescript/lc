#!/usr/bin/env ruby
$:.unshift File.expand_path('../../lib', __FILE__)

begin
  require 'linecook'
  require 'optparse'

  options = Linecook.options(
    :mode  => :render,
    :input => :args,
  )
  OptionParser.new do |opts|
    opts.banner = %{
usage: lc [options] TEMPLATE ARGS...

  Render ERB templates with arguments.

options:

}.lstrip

    opts.on("-f", "--csv-file", "read args from csv inputs") do
      options[:input] = :csv
    end

    opts.on("-l", "--list", "list templates") do
      options[:mode] = :list
    end

    opts.on("-h", "--help", "print this help") do
      puts opts
      puts
      exit
    end

  end.parse!

  mode  = options[:mode]
  input = options[:input]

  config = Linecook.setup(options)
  template_file = ARGV.shift

  case mode
  when :list
    config.templates.each_pair do |name, file|
      puts name
    end

  else
    template = \
    if File.exists?(template_file)
      Linecook::Template.new(template_file)
    else
      config.templates[template_file]
    end

    if template.nil?
      $stderr.puts "could not find template: #{template_file.inspect}"
      exit 1
    end

    case input
    when :args
      args = ARGV.dup; ARGV.clear
      print template.result(args)
    when :csv
      ARGF.each do |line|
        args = config.parse_csv(line)
        print template.result(args)
      end
    end
  end

rescue Interrupt
  exit 130
rescue Errno::EPIPE
  exit 0
end
